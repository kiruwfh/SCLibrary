--[[
    MyNewUI Library v1.2.0
    - Добавлены компоненты: Slider, Textbox, Selector, Separator.
    - Улучшена обработка CanvasSize.
]]

-- / Services
local UserInputService = game:GetService("UserInputService")
local TextService = game:GetService("TextService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

-- / Locals
local player = Players.LocalPlayer -- << Глобальная для библиотеки

-- / Core Library Table
local MyUILibrary = {}
MyUILibrary.Version = "1.2.0"
MyUILibrary._IsKeyAccepted = false

-- / Private Helper Functions
local function CreateElement(elementType, properties)
    local element = Instance.new(elementType)
    for prop, value in pairs(properties or {}) do
        pcall(function() element[prop] = value end)
    end
    return element
end

local function EnableDrag(guiObject)
    local dragging = false
    local dragInput = nil
    local dragStart = nil
    local startPos = nil
    local originalZIndex = guiObject.Parent and guiObject.Parent.DisplayOrder or 1

    local connectionBegan, connectionEnded, connectionChanged
    connectionBegan = guiObject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = guiObject.Position
            dragInput = input
            if guiObject.Parent and guiObject.Parent:IsA("ScreenGui") then
                 originalZIndex = guiObject.Parent.DisplayOrder
                 guiObject.Parent.DisplayOrder = 9999
            end
        end
    end)

    connectionEnded = guiObject.InputEnded:Connect(function(input)
        if input == dragInput then
            dragging = false
            dragInput = nil
            if guiObject.Parent and guiObject.Parent:IsA("ScreenGui") then
                 guiObject.Parent.DisplayOrder = originalZIndex
            end
        end
    end)

    connectionChanged = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            guiObject.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- Возвращаем соединения, чтобы их можно было отключить при удалении окна
    return {connectionBegan, connectionEnded, connectionChanged}
end

-- / Window Object
local Window = {}
Window.__index = Window

function Window:NewTab(title)
    title = title or "Вкладка"

    local tabButton = CreateElement("TextButton", {
        Name = title .. "_TabButton", Parent = self._tabButtonContainer, Size = UDim2.new(1, -10, 0, 28),
        BackgroundColor3 = Color3.fromRGB(55, 55, 55), TextColor3 = Color3.fromRGB(170, 170, 170),
        Font = Enum.Font.GothamSemibold, TextSize = 15, Text = title, AutoButtonColor = false,
        LayoutOrder = #self._tabButtonContainer:GetChildren() + 1
    })
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = tabButton })

    local page = CreateElement("ScrollingFrame", {
        Name = title .. "_Page", Parent = self._contentContainer, Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1.0, BorderSizePixel = 0, Visible = false, ScrollBarThickness = 5,
        ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100), CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y -- Используем автоматический размер по Y
    })
    local pageLayout = CreateElement("UIListLayout", { Name = "PageLayout", Parent = page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 6), HorizontalAlignment = Enum.HorizontalAlignment.Center })
    local pagePadding = CreateElement("UIPadding", { Parent = page, PaddingLeft = UDim.new(0, 8), PaddingRight = UDim.new(0, 8), PaddingTop = UDim.new(0, 8), PaddingBottom = UDim.new(0, 8) })

    -- Убираем ручное обновление CanvasSize, полагаемся на AutomaticCanvasSize = Y
    -- local function UpdateCanvasSize()...
    -- self.Page.ChildAdded:Connect... и т.д. больше не нужны

    tabButton.MouseButton1Click:Connect(function()
        if self._activeTabButton == tabButton then return end
        if self._activeTabButton then
            TweenService:Create(self._activeTabButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(55, 55, 55)}):Play()
            TweenService:Create(self._activeTabButton, TweenInfo.new(0.15), {TextColor3 = Color3.fromRGB(170, 170, 170)}):Play()
        end
        if self._activePage then self._activePage.Visible = false end
        TweenService:Create(tabButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(85, 85, 85)}):Play()
        TweenService:Create(tabButton, TweenInfo.new(0.15), {TextColor3 = Color3.fromRGB(230, 230, 230)}):Play()
        page.Visible = true
        self._activeTabButton = tabButton
        self._activePage = page
    end)

    if not self._activeTabButton then
         task.wait(0.1)
         pcall(function() tabButton:MouseButton1Click() end)
    end

    local Tab = {}
    Tab.Page = page
    Tab._pageLayout = pageLayout
    Tab._pagePadding = pagePadding
    -- Tab._UpdateCanvasSize = function() end -- Больше не нужна

    -- Компоненты
    function Tab:NewLabel(text, alignment)
        local label = CreateElement("TextLabel", { Name = "Label", Parent = self.Page, Text = text or "Label", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), BackgroundTransparency = 1, AutomaticSize = Enum.AutomaticSize.Y, Size = UDim2.new(1, 0, 0, 18), TextWrapped = true, TextXAlignment = alignment or Enum.TextXAlignment.Left })
        -- self:_UpdateCanvasSize() -- Не нужно
        return label
    end

    function Tab:NewButton(text, callback)
        callback = callback or function() print("Button '"..tostring(text).."' clicked") end
        local button = CreateElement("TextButton", { Name = "Button", Parent = self.Page, Text = text or "Button", Font = Enum.Font.GothamSemibold, TextSize = 14, TextColor3 = Color3.fromRGB(220, 220, 220), BackgroundColor3 = Color3.fromRGB(80, 80, 80), Size = UDim2.new(1, 0, 0, 28), AutoButtonColor = false })
        CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = button })
        button.MouseEnter:Connect(function() TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(100, 100, 100)}):Play() end)
        button.MouseLeave:Connect(function() TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(80, 80, 80)}):Play() end)
        button.MouseButton1Click:Connect(function() pcall(callback) end)
        -- self:_UpdateCanvasSize() -- Не нужно
        return button
    end

     function Tab:NewToggle(text, defaultState, callback)
        defaultState = defaultState or false
        callback = callback or function(state) print("Toggle '"..tostring(text).."' state:", state) end
        local currentState = defaultState
        local frame = CreateElement("Frame", {Name = "ToggleFrame", Parent = self.Page, Size = UDim2.new(1, 0, 0, 24), BackgroundTransparency = 1})
        local layout = CreateElement("UIListLayout", {Parent = frame, FillDirection = Enum.FillDirection.Horizontal, VerticalAlignment = Enum.VerticalAlignment.Center, Padding = UDim.new(0, 8)})
        local checkbox = CreateElement("TextButton", {Name = "Checkbox", Parent = frame, Size = UDim2.new(0, 18, 0, 18), BackgroundColor3 = Color3.fromRGB(60, 60, 60), BorderSizePixel = 0, Text = "", AutoButtonColor = false})
        CreateElement("UICorner", {CornerRadius = UDim.new(0, 3), Parent = checkbox})
        local checkmark = CreateElement("Frame", {Name = "Checkmark", Parent = checkbox, Size = UDim2.new(0.7, 0, 0.7, 0), AnchorPoint = Vector2.new(0.5, 0.5), Position = UDim2.fromScale(0.5, 0.5), BackgroundColor3 = Color3.fromRGB(150, 100, 255), BorderSizePixel = 0, Visible = currentState})
        CreateElement("UICorner", {CornerRadius = UDim.new(0, 2), Parent = checkmark})
        local label = CreateElement("TextLabel", {Name = "ToggleLabel", Parent = frame, Text = text or "Toggle", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), BackgroundTransparency = 1, Size = UDim2.new(1, -30, 1, 0), TextXAlignment = Enum.TextXAlignment.Left})
        local function UpdateState(newState) currentState = newState; checkmark.Visible = currentState; pcall(callback, currentState) end
        checkbox.MouseButton1Click:Connect(function() UpdateState(not currentState) end)
        -- self:_UpdateCanvasSize() -- Не нужно
        local control = {}; function control:Set(state) UpdateState(state) end; function control:Get() return currentState end; function control:Remove() frame:Destroy() end; return control
    end

    function Tab:NewSeparator()
        local sep = CreateElement("Frame", { Name = "Separator", Parent = self.Page, Size = UDim2.new(1, -10, 0, 1), BackgroundColor3 = Color3.fromRGB(70, 70, 75), BorderSizePixel = 0 })
        -- self:_UpdateCanvasSize() -- Не нужно
        return sep
    end

    function Tab:NewTextbox(text, options, callback)
        options = options or {}
        callback = callback or function(value) print("Textbox '"..tostring(text).."' value:", value) end
        local placeholder = options.Placeholder or "Введите текст..."
        local defaultText = options.Default or ""

        local frame = CreateElement("Frame", { Name = "TextboxFrame", Parent = self.Page, Size = UDim2.new(1, 0, 0, 50), BackgroundTransparency = 1 }) -- Высота контейнера
        local layout = CreateElement("UIListLayout", {Parent = frame, Padding = UDim.new(0, 4)})
        local label = CreateElement("TextLabel", { Name = "TextboxLabel", Parent = frame, Text = text or "Textbox", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })
        local textbox = CreateElement("TextBox", { Name = "TextboxInput", Parent = frame, Text = defaultText, PlaceholderText = placeholder, Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(230, 230, 230), BackgroundColor3 = Color3.fromRGB(55, 55, 60), BorderSizePixel = 0, Size = UDim2.new(1, 0, 0, 26), ClearTextOnFocus = false, TextXAlignment = Enum.TextXAlignment.Left })
        CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = textbox })
        CreateElement("UIPadding", { Parent = textbox, PaddingLeft = UDim.new(0, 5), PaddingRight = UDim.new(0, 5) })

        textbox.FocusLost:Connect(function(enterPressed)
            pcall(callback, textbox.Text) -- Вызываем callback при потере фокуса
        end)
        -- self:_UpdateCanvasSize() -- Не нужно
        local control = {}
        function control:Set(value) textbox.Text = tostring(value) end
        function control:Get() return textbox.Text end
        function control:Remove() frame:Destroy() end
        return control
    end

     function Tab:NewSlider(text, options, callback)
        options = options or {}
        callback = callback or function(value) print("Slider '"..tostring(text).."' value:", value) end
        local minVal = options.Min or 0
        local maxVal = options.Max or 100
        local defaultVal = options.Default or minVal
        local increment = options.Increment or 1
        local suffix = options.Suffix or ""

        local currentValue = defaultVal
        local isDragging = false

        local frame = CreateElement("Frame", { Name = "SliderFrame", Parent = self.Page, Size = UDim2.new(1, 0, 0, 42), BackgroundTransparency = 1 })
        local layout = CreateElement("UIListLayout", {Parent = frame, Padding = UDim.new(0, 4)})
        local topRow = CreateElement("Frame", { Name = "TopRow", Parent = frame, Size = UDim2.new(1, 0, 0, 18), BackgroundTransparency = 1 })
        local topLayout = CreateElement("UIListLayout", {Parent = topRow, FillDirection = Enum.FillDirection.Horizontal, VerticalAlignment = Enum.VerticalAlignment.Center})
        local label = CreateElement("TextLabel", { Name = "SliderLabel", Parent = topRow, Text = text or "Slider", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), BackgroundTransparency = 1, Size = UDim2.new(0.7, 0, 1, 0), TextXAlignment = Enum.TextXAlignment.Left })
        local valueLabel = CreateElement("TextLabel", { Name = "ValueLabel", Parent = topRow, Text = tostring(currentValue)..suffix, Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(180, 180, 180), BackgroundTransparency = 1, Size = UDim2.new(0.3, -5, 1, 0), TextXAlignment = Enum.TextXAlignment.Right })
        local track = CreateElement("Frame", { Name = "Track", Parent = frame, Size = UDim2.new(1, 0, 0, 18), BackgroundColor3 = Color3.fromRGB(55, 55, 60), BorderSizePixel = 0 })
        CreateElement("UICorner", {CornerRadius = UDim.new(1,0), Parent = track})
        local fill = CreateElement("Frame", { Name = "Fill", Parent = track, Size = UDim2.fromScale(0, 1), BackgroundColor3 = Color3.fromRGB(150, 100, 255), BorderSizePixel = 0 })
        CreateElement("UICorner", {CornerRadius = UDim.new(1,0), Parent = fill})
        local thumb = CreateElement("Frame", { Name = "Thumb", Parent = track, Size = UDim2.new(0, 10, 0, 10), BackgroundColor3 = Color3.fromRGB(200, 200, 200), BorderSizePixel = 0, AnchorPoint = Vector2.new(0.5, 0.5), Position = UDim2.fromScale(0, 0.5) })
        CreateElement("UICorner", {CornerRadius = UDim.new(1,0), Parent = thumb})

        local function UpdateVisuals(value)
            local percentage = math.clamp(((value or currentValue) - minVal) / (maxVal - minVal), 0, 1)
            if maxVal == minVal then percentage = 0 end -- Avoid NaN
            fill.Size = UDim2.new(percentage, 0, 1, 0)
            thumb.Position = UDim2.new(percentage, 0, 0.5, 0)
            valueLabel.Text = tostring(math.floor(((value or currentValue)*10^2)+0.5)/(10^2)) .. suffix -- Round to 2 decimal places for display
        end

        local function SetValue(newValue, runCallback)
            local snappedValue = math.clamp(math.floor((newValue - minVal) / increment + 0.5) * increment + minVal, minVal, maxVal)
            if snappedValue == currentValue then return end
            currentValue = snappedValue
            UpdateVisuals()
            if runCallback then pcall(callback, currentValue) end
        end

        track.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                isDragging = true
                local mouseX = input.Position.X
                local trackStartX = track.AbsolutePosition.X
                local trackWidth = track.AbsoluteSize.X
                local percentage = math.clamp((mouseX - trackStartX) / trackWidth, 0, 1)
                SetValue(minVal + percentage * (maxVal - minVal), true)
            end
        end)
        track.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then isDragging = false end end)
        UserInputService.InputChanged:Connect(function(input)
            if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local mouseX = input.Position.X
                local trackStartX = track.AbsolutePosition.X
                local trackWidth = track.AbsoluteSize.X
                local percentage = math.clamp((mouseX - trackStartX) / trackWidth, 0, 1)
                SetValue(minVal + percentage * (maxVal - minVal), true)
            end
        end)

        UpdateVisuals(defaultVal) -- Set initial visuals
        -- self:_UpdateCanvasSize() -- Не нужно
        local control = {}
        function control:Set(value, silent) SetValue(value, not silent) end
        function control:Get() return currentValue end
        function control:Remove() frame:Destroy() end
        return control
    end

    function Tab:NewSelector(text, optionsList, defaultOption, callback)
        optionsList = optionsList or {"Option1", "Option2"}
        defaultOption = defaultOption or optionsList[1]
        callback = callback or function(selected) print("Selector '"..tostring(text).."' selected:", selected) end
        local currentSelection = defaultOption
        local isOpen = false

        local frame = CreateElement("Frame", { Name = "SelectorFrame", Parent = self.Page, Size = UDim2.new(1, 0, 0, 52), BackgroundTransparency = 1, ClipsDescendants = false, ZIndex = 2 }) -- Higher ZIndex base
        local layout = CreateElement("UIListLayout", {Parent = frame, Padding = UDim.new(0, 4)})
        local label = CreateElement("TextLabel", { Name = "SelectorLabel", Parent = frame, Text = text or "Selector", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })

        local dropdownButton = CreateElement("TextButton", { Name = "DropdownButton", Parent = frame, Text = tostring(currentSelection), Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(220, 220, 220), BackgroundColor3 = Color3.fromRGB(55, 55, 60), Size = UDim2.new(1, 0, 0, 28), AutoButtonColor = false, TextXAlignment = Enum.TextXAlignment.Left })
        CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = dropdownButton })
        CreateElement("UIPadding", { Parent = dropdownButton, PaddingLeft = UDim.new(0, 8), PaddingRight = UDim.new(0, 20) }) -- Space for arrow
        local arrow = CreateElement("ImageLabel", { Name = "Arrow", Parent = dropdownButton, Size = UDim2.new(0, 12, 0, 12), Position = UDim2.new(1, -15, 0.5, 0), AnchorPoint = Vector2.new(1, 0.5), Image = "rbxassetid://3926305904", ImageColor3 = Color3.fromRGB(180, 180, 180), BackgroundTransparency = 1, Rotation = 0 })

        local optionsFrame = CreateElement("ScrollingFrame", { Name = "OptionsFrame", Parent = frame, Size = UDim2.new(1, 0, 0, 0), Position = UDim2.new(0, 0, 1, 0), BackgroundColor3 = Color3.fromRGB(55, 55, 60), BorderSizePixel = 1, BorderColor3 = Color3.fromRGB(80, 80, 90), Visible = false, ClipsDescendants = true, CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 4, ZIndex = 10 }) -- High ZIndex when open
        CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = optionsFrame })
        local optionsLayout = CreateElement("UIListLayout", {Parent = optionsFrame, Padding = UDim.new(0, 1)})

        local function ToggleDropdown()
            isOpen = not isOpen
            optionsFrame.Visible = isOpen
            if isOpen then
                frame.ZIndex = 10 -- Bring whole control to front
                -- Populate options
                for _, child in ipairs(optionsFrame:GetChildren()) do if child:IsA("TextButton") then child:Destroy() end end
                local canvasHeight = 0
                for _, optionText in ipairs(optionsList) do
                    local optButton = CreateElement("TextButton", {
                        Name = "OptionButton", Parent = optionsFrame, Text = tostring(optionText), Font = Enum.Font.Code, TextSize = 14,
                        TextColor3 = (tostring(optionText) == tostring(currentSelection)) and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180),
                        BackgroundColor3 = (tostring(optionText) == tostring(currentSelection)) and Color3.fromRGB(75, 75, 80) or Color3.fromRGB(55, 55, 60),
                        Size = UDim2.new(1, 0, 0, 24), AutoButtonColor = false, TextXAlignment = Enum.TextXAlignment.Left
                    })
                    CreateElement("UIPadding", { Parent = optButton, PaddingLeft = UDim.new(0, 8) })
                    optButton.MouseEnter:Connect(function() if tostring(optButton.Text) ~= tostring(currentSelection) then optButton.BackgroundColor3 = Color3.fromRGB(70, 70, 75) end end)
                    optButton.MouseLeave:Connect(function() if tostring(optButton.Text) ~= tostring(currentSelection) then optButton.BackgroundColor3 = Color3.fromRGB(55, 55, 60) end end)
                    optButton.MouseButton1Click:Connect(function()
                        currentSelection = optionText
                        dropdownButton.Text = tostring(currentSelection)
                        pcall(callback, currentSelection)
                        ToggleDropdown() -- Close after selection
                    end)
                    canvasHeight = canvasHeight + 24 + optionsLayout.Padding.Offset
                end
                optionsFrame.CanvasSize = UDim2.new(0, 0, 0, canvasHeight - optionsLayout.Padding.Offset)
                local targetHeight = math.min(150, optionsFrame.CanvasSize.Y.Offset + 4) -- Max height 150 + border
                TweenService:Create(optionsFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, targetHeight)}):Play()
                TweenService:Create(arrow, TweenInfo.new(0.2), {Rotation = 180}):Play()
            else
                TweenService:Create(optionsFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 0)}):Play()
                TweenService:Create(arrow, TweenInfo.new(0.2), {Rotation = 0}):Play()
                task.wait(0.2)
                optionsFrame.Visible = false
                frame.ZIndex = 2 -- Reset ZIndex
            end
        end
        dropdownButton.MouseButton1Click:Connect(ToggleDropdown)
        -- self:_UpdateCanvasSize() -- Не нужно
        local control = {}
        function control:Set(value, silent)
             local found = false; for _,opt in ipairs(optionsList) do if tostring(opt) == tostring(value) then currentSelection = opt; dropdownButton.Text = tostring(currentSelection); found = true; break end end
             if found and not silent then pcall(callback, currentSelection) end
        end
        function control:Get() return currentSelection end
        function control:Remove() frame:Destroy() end
        -- TODO: Add AddOption, RemoveOption, ClearOptions, SetOptions
        return control
    end

    -- TODO: Add NewKeybind

    return Tab
end

function Window:ToggleVisible()
    if self.ScreenGui then self.ScreenGui.Enabled = not self.ScreenGui.Enabled; print("[MyNewUI] Visibility toggled to:", self.ScreenGui.Enabled) end
end

function Window:SetTitle(title)
    if self._headerLabel then self._headerLabel.Text = title or "My UI Library" end
end

function Window:Remove()
    if self._toggleConnection then self._toggleConnection:Disconnect(); self._toggleConnection = nil end
    -- Отключаем соединения Drag
    if self._dragConnections then
        for _, conn in ipairs(self._dragConnections) do conn:Disconnect() end
        self._dragConnections = nil
    end
    if self.ScreenGui then print("[MyNewUI] Removing UI."); self.ScreenGui:Destroy(); for k, v in pairs(self) do self[k] = nil end end
end

-- / Key System
function MyUILibrary:RequestKey(options)
    options = options or {}
    local correctKey = options.CorrectKey or "DEFAULT_KEY"
    local onSuccess = options.OnSuccess or function() print("[MyNewUI] Key Correct!") end
    local keyPromptName = "MyNewUI_KeyPrompt"
    local existingPrompt = CoreGui:FindFirstChild(keyPromptName)
    if existingPrompt then existingPrompt:Destroy() end

    local screenGui = CreateElement("ScreenGui", {Name = keyPromptName, Parent = CoreGui, DisplayOrder = 10000, ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
    local overlay = CreateElement("Frame", {Name = "Overlay", Parent = screenGui, Size = UDim2.fromScale(1, 1), BackgroundColor3 = Color3.new(0, 0, 0), BackgroundTransparency = 0.6, Active = true})
    local promptBox = CreateElement("Frame", {Name = "PromptBox", Parent = overlay, Size = UDim2.new(0, 300, 0, 160), AnchorPoint = Vector2.new(0.5, 0.5), Position = UDim2.fromScale(0.5, 0.5), BackgroundColor3 = Color3.fromRGB(40, 40, 45), BorderSizePixel = 0})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 4), Parent = promptBox })
    local title = CreateElement("TextLabel", {Name = "Title", Parent = promptBox, Size = UDim2.new(1, 0, 0, 35), BackgroundColor3 = Color3.fromRGB(55, 55, 60), Text = "Требуется Ключ", Font = Enum.Font.GothamSemibold, TextSize = 16, TextColor3 = Color3.fromRGB(220, 220, 225)})
    local infoLabel = CreateElement("TextLabel", {Name = "Info", Parent = promptBox, Size = UDim2.new(0.9, 0, 0, 20), Position = UDim2.new(0.5, 0, 0, 45), AnchorPoint = Vector2.new(0.5, 0), Text = "Введите ключ доступа:", Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(180, 180, 180), BackgroundTransparency = 1})
    local keyInput = CreateElement("TextBox", {Name = "Input", Parent = promptBox, Size = UDim2.new(0.8, 0, 0, 30), Position = UDim2.new(0.5, 0, 0, 75), AnchorPoint = Vector2.new(0.5, 0), BackgroundColor3 = Color3.fromRGB(30, 30, 35), BorderSizePixel = 0, Font = Enum.Font.Code, TextSize = 14, TextColor3 = Color3.fromRGB(210, 210, 210), PlaceholderText = "Ключ...", PlaceholderColor3 = Color3.fromRGB(100, 100, 100), ClearTextOnFocus = false})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = keyInput })
    local submitButton = CreateElement("TextButton", {Name = "Submit", Parent = promptBox, Size = UDim2.new(0.5, 0, 0, 30), Position = UDim2.new(0.5, 0, 0, 115), AnchorPoint = Vector2.new(0.5, 0), BackgroundColor3 = Color3.fromRGB(80, 80, 90), Font = Enum.Font.GothamSemibold, Text = "Ввод", TextSize = 14, TextColor3 = Color3.fromRGB(220, 220, 220), AutoButtonColor = false})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = submitButton })

    submitButton.MouseEnter:Connect(function() submitButton.BackgroundColor3 = Color3.fromRGB(100, 100, 110) end)
    submitButton.MouseLeave:Connect(function() submitButton.BackgroundColor3 = Color3.fromRGB(80, 80, 90) end)

    local function checkKey()
        if keyInput.Text == correctKey then
            MyUILibrary._IsKeyAccepted = true
            screenGui:Destroy()
            pcall(onSuccess)
        else
            infoLabel.Text = "Неверный ключ!"
            infoLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
            keyInput.Text = ""
            local originalPos = promptBox.Position
            local tween = TweenService:Create(promptBox, TweenInfo.new(0.08, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 4, true), {Position = originalPos + UDim2.new(0, 5, 0, 0)})
            tween:Play()
            tween.Completed:Connect(function() if promptBox and promptBox.Parent then promptBox.Position = originalPos end end) -- Check existence
        end
    end

    submitButton.MouseButton1Click:Connect(checkKey)
    keyInput.FocusLost:Connect(function(enterPressed) if enterPressed then checkKey() end end)
    print("[MyNewUI] Key prompt displayed.")
end

-- / Greeting Screen
function MyUILibrary:ShowGreeting(options, callback)
    options = options or {}
    callback = callback or function() print("[MyNewUI] Greeting finished.") end
    local duration = options.Duration or 2.5
    local greetingName = "MyNewUI_Greeting"
    local existingGreeting = CoreGui:FindFirstChild(greetingName)
    if existingGreeting then existingGreeting:Destroy() end

    local screenGui = CreateElement("ScreenGui", {Name = greetingName, Parent = CoreGui, DisplayOrder = 10001, ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
    local overlay = CreateElement("Frame", {Name = "Overlay", Parent = screenGui, Size = UDim2.fromScale(1, 1), BackgroundColor3 = Color3.new(0, 0, 0), BackgroundTransparency = 1})
    local textLabel = CreateElement("TextLabel", {Name = "WelcomeText", Parent = overlay, Size = UDim2.new(1, -40, 0, 50), Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5), Text = "Добро пожаловать, " .. (player and player.DisplayName or "Игрок") .. "!", Font = Enum.Font.GothamBold, TextSize = 24, TextColor3 = Color3.fromRGB(230, 230, 230), TextWrapped = true, BackgroundTransparency = 1, TextTransparency = 1})
    local loadBarBg = CreateElement("Frame", {Name = "LoadBarBg", Parent = overlay, Size = UDim2.new(0.5, 0, 0, 6), Position = UDim2.new(0.5, 0, 0.6, 0), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundColor3 = Color3.fromRGB(60, 60, 65), BackgroundTransparency = 1, BorderSizePixel = 0})
    CreateElement("UICorner", {CornerRadius = UDim.new(1,0), Parent = loadBarBg})
    local loadBarFill = CreateElement("Frame", {Name = "LoadBarFill", Parent = loadBarBg, Size = UDim2.fromScale(0, 1), BackgroundColor3 = Color3.fromRGB(150, 100, 255), BorderSizePixel = 0})
    CreateElement("UICorner", {CornerRadius = UDim.new(1,0), Parent = loadBarFill})

    local fadeInTime = 0.4
    local waitTime = math.max(0, duration - (fadeInTime * 2))
    local loadTime = math.max(0.1, waitTime * 0.8)

    TweenService:Create(overlay, TweenInfo.new(fadeInTime), {BackgroundTransparency = 0.6}):Play()
    local textTween = TweenService:Create(textLabel, TweenInfo.new(fadeInTime, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 0, false, fadeInTime * 0.5), {TextTransparency = 0})
    textTween:Play()
    TweenService:Create(loadBarBg, TweenInfo.new(fadeInTime, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 0, false, fadeInTime * 0.6), {BackgroundTransparency = 0.5}):Play()
    local loadTween = TweenService:Create(loadBarFill, TweenInfo.new(loadTime, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, 0, false, fadeInTime * 0.8), {Size = UDim2.fromScale(1, 1)})
    loadTween:Play()

    task.delay(duration - fadeInTime, function()
        TweenService:Create(overlay, TweenInfo.new(fadeInTime), {BackgroundTransparency = 1}):Play()
        TweenService:Create(textLabel, TweenInfo.new(fadeInTime), {TextTransparency = 1}):Play()
        TweenService:Create(loadBarBg, TweenInfo.new(fadeInTime), {BackgroundTransparency = 1}):Play()
        task.delay(fadeInTime, function()
            if screenGui and screenGui.Parent then screenGui:Destroy() end
            pcall(callback)
        end)
    end)
    print("[MyNewUI] Greeting displayed.")
end

-- / Library Initialization Function (Main UI)
function MyUILibrary:Init(options)
    if not MyUILibrary._IsKeyAccepted then
         warn("[MyNewUI] Init called, but key was not accepted. Use RequestKey first.")
         return nil
    end

    options = options or {}
    local title = options.Title or "My UI Library"
    local toggleKey = options.ToggleKey or Enum.KeyCode.RightControl
    local initialSize = options.Size or UDim2.new(0, 550, 0, 350)
    local initialPosition = options.Position or UDim2.fromScale(0.5, 0.5)
    local uiName = "MyNewUI_Screen"

    print("[MyNewUI] Initializing Main UI...")

    local existingGui = CoreGui:FindFirstChild(uiName)
    if existingGui then warn("[MyNewUI] Main UI already exists. Destroying old one."); existingGui:Destroy() end

    local screenGui = CreateElement("ScreenGui", {Name = uiName, Parent = CoreGui, ZIndexBehavior = Enum.ZIndexBehavior.Sibling, DisplayOrder = 9990})
    local mainFrame = CreateElement("Frame", {Name = "MainFrame", Parent = screenGui, Size = initialSize, Position = initialPosition, AnchorPoint = Vector2.new(0.5, 0.5), BackgroundColor3 = Color3.fromRGB(40, 40, 45), BorderSizePixel = 1, BorderColor3 = Color3.fromRGB(80, 80, 90)})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 5), Parent = mainFrame })
    local dragConnections = EnableDrag(mainFrame) -- Сохраняем соединения

    local header = CreateElement("Frame", {Name = "Header", Parent = mainFrame, Size = UDim2.new(1, 0, 0, 30), BackgroundColor3 = Color3.fromRGB(55, 55, 60), BorderSizePixel = 0})
    local headerLabel = CreateElement("TextLabel", {Name = "Title", Parent = header, Size = UDim2.new(1, -10, 1, 0), Position = UDim2.fromOffset(5, 0), Text = title, Font = Enum.Font.GothamSemibold, TextSize = 16, TextColor3 = Color3.fromRGB(220, 220, 225), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left})
    local contentArea = CreateElement("Frame", {Name = "ContentArea", Parent = mainFrame, Size = UDim2.new(1, 0, 1, -30), Position = UDim2.fromOffset(0, 30), BackgroundTransparency = 1})
    local tabButtonContainer = CreateElement("ScrollingFrame", {Name = "TabButtonContainer", Parent = contentArea, Size = UDim2.new(0, 130, 1, -10), Position = UDim2.fromOffset(5, 5), BackgroundColor3 = Color3.fromRGB(45, 45, 50), BorderSizePixel = 0, CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 4})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = tabButtonContainer })
    CreateElement("UIListLayout", {Parent = tabButtonContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4), HorizontalAlignment = Enum.HorizontalAlignment.Center})
    CreateElement("UIPadding", { Parent = tabButtonContainer, Padding = UDim.new(0,5)})
    local contentContainer = CreateElement("Frame", {Name = "ContentContainer", Parent = contentArea, Size = UDim2.new(1, -140, 1, -10), Position = UDim2.fromOffset(135, 5), BackgroundColor3 = Color3.fromRGB(45, 45, 50), BorderSizePixel = 0, ClipsDescendants = true})
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 3), Parent = contentContainer })

    local windowInstance = {}
    setmetatable(windowInstance, Window)
    windowInstance.ScreenGui = screenGui
    windowInstance.MainFrame = mainFrame
    windowInstance._headerLabel = headerLabel
    windowInstance._tabButtonContainer = tabButtonContainer
    windowInstance._contentContainer = contentContainer
    windowInstance._activeTabButton = nil
    windowInstance._activePage = nil
    windowInstance._toggleKey = toggleKey
    windowInstance._dragConnections = dragConnections -- Сохраняем для отключения

    windowInstance._toggleConnection = UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
        if not gameProcessedEvent and input.KeyCode == windowInstance._toggleKey then
            windowInstance:ToggleVisible()
        end
    end)

    print("[MyNewUI] Main UI Initialization complete.")
    return windowInstance
end

MyUILibrary._IsKeyAccepted = false

return MyUILibrary
